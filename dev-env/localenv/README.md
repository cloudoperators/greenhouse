
# Setting up development environment

This handy CLI tool will help you to setup your development environment in no time.
## Prerequisites
- [docker](https://docs.docker.com/get-docker/)
- [KinD](https://kind.sigs.k8s.io/docs/user/quick-start/)
- [kubectl](https://kubernetes.io/docs/tasks/tools/install-kubectl/)
## Usage

You can use `greenhousectl` either by downloading the latest binary from [here](https://github.com/cloudoperators/greenhouse/releases)

Or you can build it from source by running the following command: `build-greenhousectl`

> [!NOTE]  
> The CLI binary will be available in the `bin` folder

## Additional information

Charts needed for dev env setup for `KinD`

- `charts/manager`
- `charts/idproxy`

When setting up your development environment, certain resources are modified for development convenience -

 - The manager `Deployment` has environment variables `WEBHOOK_ONLY` and `CONTROLLERS_ONLY`
 - `WEBHOOK_ONLY=true` will only run the webhook server
 - `CONTROLLERS_ONLY=true` will only run the controllers
 - Only one of the above can be set to `true` at a time otherwise the manager will error out

if `DevMode` is enabled for webhooks then depending on the OS the webhook manifests are altered by removing `clientConfig.service` and 
replacing it with `clientConfig.url`, allowing you to debug the code locally.

> [!NOTE]  
> The `DevMode` can be enabled by setting the `--dev-mode` flag while individually setting up the webhook or by setting the `devMode` key to `true` in the `dev-env/localenv/sample.config.json` file.

- `linux` - the ipv4 addr from `docker0` interface is used - ex: `https://172.17.0.2:9443/<path>`
- `macOS` - host.docker.internal is used - ex: `https://host.docker.internal:9443/<path>`
- `windows` - ideally `host.docker.internal` should work, otherwise please reach out with a contribution :heart
- webhook certs are generated by `charts/manager/templates/kube-webhook-certgen.yaml` Job in-cluster and they are extracted and saved to `/tmp/k8s-webhook-server/serving-certs`
- `kubeconfig` of the created cluster(s) are saved to `/tmp/greenhouse/<clusterName>.kubeconfig`

Below you will find a list of commands available for dev env setup
  
---
## greenhousectl dev cluster create

Create a kinD cluster

### Synopsis

Create a kinD cluster and setup the greenhouse namespace optionally

```
greenhousectl dev cluster create [flags]
```

### Examples

```
greenhousectl dev cluster create --name <my-cluster-name> --namespace <my-namespace> --version <v1.30.3>
```

### Options

```
      --config string      create the cluster with a specific kind configuration file - e.g. --config <path>/<to>/<config>
  -h, --help               help for create
  -c, --name string        create a kind cluster with a name - e.g. -c <my-cluster>
  -n, --namespace string   create a namespace in the cluster - e.g. -c <my-cluster> -n <my-namespace>
      --version string     create the cluster with a specific version - e.g. -v <v1.30.3>
```

## greenhousectl dev cluster delete

Delete a kinD cluster

### Synopsis

Delete a specific kinD cluster

```
greenhousectl dev cluster delete [flags]
```

### Examples

```
greenhousectl dev cluster delete --name <my-cluster-name>
```

### Options

```
  -h, --help          help for delete
  -c, --name string   delete the kind cluster - e.g. -c <my-cluster>
```

## greenhousectl dev setup manifest

install manifests for Greenhouse

### Synopsis

install CRDs, Webhook definitions, RBACs, Certs, etc... for Greenhouse into the target cluster

```
greenhousectl dev setup manifest [flags]
```

### Examples

```

# Install manifests for Greenhouse into the target cluster (All manifests except Deployment - recommended)
greenhousectl dev setup manifest --name greenhouse-admin --namespace greenhouse --release greenhouse --chart-path charts/manager

# Install only CRDs for Greenhouse into the target cluster
greenhousectl dev setup manifest --name greenhouse-admin --namespace greenhouse --release greenhouse --chart-path charts/idproxy --crd-only

# Install manifests with excluded kinds for Greenhouse into the target cluster (Caution: Only exclude if you know what you are doing)
greenhousectl dev setup manifest --name greenhouse-admin --namespace greenhouse --release greenhouse --chart-path charts/manager --excludeKinds Deployment --excludeKinds Job

# Install manifests for Greenhouse into the target cluster with values file
greenhousectl dev setup manifest --name greenhouse-admin --namespace greenhouse --release greenhouse --chart-path charts/manager --values-path dev-env/localenv/sample.values.yaml

```

### Options

```
  -p, --chart-path string          local absolute chart path where manifests are located - e.g. <path>/<to>/charts/manager
  -d, --crd-only                   Install only CRDs
  -e, --excludeKinds stringArray   Exclude kinds from the generated manifests: ex: -e Deployment -e Job (default [Deployment])
  -h, --help                       help for manifest
  -c, --name string                Name of the kind cluster - e.g. greenhouse-123 (without the kind prefix)
  -n, --namespace string           namespace to install the resources
  -r, --release string             Helm release name, Default value: greenhouse - e.g. your-release-name (default "greenhouse")
  -v, --values-path string         local absolute values file path - e.g. <path>/<to>/my-values.yaml
      --version string             create the cluster with a specific version - e.g. -v <v1.30.3>
```

## greenhousectl dev setup webhook

Setup webhooks for Greenhouse (Validating and Mutating webhooks)

### Synopsis

Setup Validating and Mutating webhooks for Greenhouse controller development convenience

```
greenhousectl dev setup webhook [flags]
```

### Examples

```

# Setup webhook for Greenhouse controller development convenience (Webhooks run in cluster)
greenhousectl dev setup webhook --name greenhouse-admin --namespace greenhouse --release greenhouse --chart-path charts/manager --dockerfile ./

# Setup webhook for Greenhouse webhook development convenience (Webhooks run local)
greenhousectl dev setup webhook --name greenhouse-admin --namespace greenhouse --release greenhouse --chart-path charts/manager --dockerfile ./ --dev-mode

# Additionally provide values file (defaults may not work since charts change over time)
greenhousectl dev setup webhook --name greenhouse-admin --namespace greenhouse --release greenhouse --chart-path charts/manager --dockerfile ./ --values-path hack/localenv/sample.values.yaml


```

### Options

```
  -p, --chart-path string    local chart path where manifests are located - e.g. <path>/<to>/charts/manager
      --config string        create the cluster with a specific kind configuration file - e.g. --config <path>/<to>/<config>
  -m, --dev-mode             Enable dev mode for webhook setup - Note: Admission Webhooks will be modified for local development
  -f, --dockerfile string    local path to the Dockerfile of greenhouse manager
  -h, --help                 help for webhook
  -c, --name string          Name of the kind cluster - e.g. my-cluster (without the kind prefix)
  -n, --namespace string     namespace to install the resources
  -r, --release string       Helm release name, Default value: greenhouse - e.g. your-release-name (default "greenhouse")
  -v, --values-path string   local absolute values file path - e.g. <path>/<to>/my-values.yaml
      --version string       create the cluster with a specific version - e.g. -v <v1.30.3>
```

## greenhousectl dev setup

setup dev environment

### Synopsis

setup dev environment with a configuration file

```
greenhousectl dev setup [flags]
```

### Examples

```

# Setup Greenhouse dev environment with a configuration file
greenhousectl dev setup -f dev-env/localenv/dev.config.yaml

- This will create an admin and a remote cluster
- Install CRDs, Webhook definitions, RBACs, Certs, etc... for Greenhouse into the target cluster
- Depending on the devMode, it will install the webhook in-cluster or enable it for local development

```

### Options

```
  -f, --config string   configuration file path - e.g. -f dev-env/localenv/dev.config.yaml
  -h, --help            help for setup
```


## Generating Docs
To generate the markdown documentation, run the following command:
```shell
make dev-docs
```
